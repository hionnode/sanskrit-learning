---
import BaseLayout from './BaseLayout.astro';
import LessonNav from '../components/astro/LessonNav.astro';
import ExerciseSet from '../components/islands/exercises/ExerciseSet.tsx';
import type { Lesson } from '../lib/content-helpers';
import { getModulesForStage, getPrevNextLesson } from '../lib/content-helpers';

interface Props {
  lesson: Lesson;
}

const { lesson } = Astro.props;
const { prev, next } = await getPrevNextLesson(lesson.id);
const modules = await getModulesForStage(lesson.data.stage);
const exercises = lesson.data.exercises;
---
<BaseLayout title={lesson.data.title_hi}>
  <div class="max-w-5xl mx-auto px-4 py-8">
    <div class="lg:grid lg:grid-cols-[220px_1fr] lg:gap-8">
      <!-- Sidebar (desktop only) -->
      <aside class="hidden lg:block">
        <nav class="sticky top-20 space-y-4" aria-label="मॉड्यूल नेविगेशन">
          {modules.map((mod) => (
            <div>
              <h3 class="text-xs font-bold uppercase tracking-wider text-stone-400 dark:text-stone-500 mb-2">
                {mod.title_hi}
              </h3>
              <ul class="space-y-1">
                {mod.lessons.map((l) => (
                  <li>
                    <a
                      href={`/hi/learn/${l.id}`}
                      class:list={[
                        'block px-3 py-1.5 rounded text-sm transition-colors min-h-[36px] flex items-center',
                        l.id === lesson.id
                          ? 'bg-saffron-500/10 text-saffron-700 dark:text-saffron-500 font-medium'
                          : 'text-stone-600 dark:text-stone-400 hover:bg-amber-50 dark:hover:bg-charcoal-800',
                      ]}
                    >
                      {l.data.title_hi}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </nav>
      </aside>

      <!-- Main content -->
      <article class="min-w-0">
        <header class="mb-8">
          <p class="text-sm text-saffron-600 dark:text-saffron-500 font-medium mb-1">
            {lesson.data.module_title_hi}
          </p>
          <h1 class="text-2xl md:text-3xl font-bold text-stone-900 dark:text-stone-100 leading-tight">
            {lesson.data.title_hi}
          </h1>
          <p class="mt-2 text-sm text-stone-500 dark:text-stone-400">
            अनुमानित समय: {lesson.data.estimated_minutes} मिनट
          </p>
        </header>

        <div class="prose prose-stone dark:prose-invert prose-headings:font-devanagari prose-table:text-sm max-w-none
          prose-th:bg-amber-50 dark:prose-th:bg-charcoal-800 prose-th:px-3 prose-th:py-2
          prose-td:px-3 prose-td:py-2 prose-table:border-collapse
          prose-th:border prose-th:border-amber-200 dark:prose-th:border-charcoal-700
          prose-td:border prose-td:border-amber-200 dark:prose-td:border-charcoal-700">
          <slot />
        </div>

        {exercises.length > 0 && (
          <section class="mt-12 pt-8 border-t border-amber-200 dark:border-charcoal-700">
            <h2 class="text-xl font-bold text-stone-900 dark:text-stone-100 mb-6">अभ्यास</h2>
            <ExerciseSet exercises={exercises} client:visible />
          </section>
        )}

        <LessonNav prev={prev} next={next} />
      </article>
    </div>
  </div>
</BaseLayout>
