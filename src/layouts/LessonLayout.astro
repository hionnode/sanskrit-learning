---
import BaseLayout from './BaseLayout.astro';
import LessonNav from '../components/astro/LessonNav.astro';
import ExerciseSet from '../components/islands/exercises/ExerciseSet.tsx';
import type { Lesson } from '../lib/content-helpers';
import { getModulesForStage, getPrevNextLesson } from '../lib/content-helpers';

interface Props {
  lesson: Lesson;
}

const { lesson } = Astro.props;
const { prev, next } = await getPrevNextLesson(lesson.id);
const modules = await getModulesForStage(lesson.data.stage);
const exercises = lesson.data.exercises;
---
<BaseLayout title={lesson.data.title_hi} description={`${lesson.data.title_hi} — ${lesson.data.module_title_hi} | संस्कृत शिक्षा`}>
  <div class="max-w-5xl mx-auto px-4 py-8">
    <!-- Breadcrumb (visible on all screens) -->
    <nav aria-label="ब्रेडक्रम्ब" class="mb-6 text-sm text-clay dark:text-stone-400">
      <ol class="flex flex-wrap items-center gap-1">
        <li><a href="/hi/learn" class="hover:text-vermillion dark:hover:text-vermillion-light transition-colors min-h-[44px] inline-flex items-center">सीखें</a></li>
        <li aria-hidden="true" class="mx-1">/</li>
        <li><span class="text-stone-700 dark:text-stone-300">{lesson.data.module_title_hi}</span></li>
        <li aria-hidden="true" class="mx-1">/</li>
        <li><span class="font-medium text-ink dark:text-stone-200" aria-current="page">{lesson.data.title_hi}</span></li>
      </ol>
    </nav>

    <!-- Mobile module navigation -->
    <details class="lg:hidden mb-6 rounded-lg border border-border-subtle dark:border-charcoal-700 bg-white dark:bg-charcoal-800">
      <summary class="flex items-center justify-between cursor-pointer px-4 py-3 text-sm font-medium text-stone-700 dark:text-stone-300 min-h-[44px]">
        <span>इस मॉड्यूल के पाठ</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-stone-400 transition-transform" aria-hidden="true"><polyline points="6 9 12 15 18 9" /></svg>
      </summary>
      <nav class="px-4 pb-3" aria-label="मॉड्यूल पाठ सूची">
        {modules.map((mod) => (
          <div class="mb-3">
            <p class="text-xs font-bold uppercase tracking-wider text-stone-400 dark:text-stone-500 mb-1">{mod.title_hi}</p>
            <ul class="space-y-1">
              {mod.lessons.map((l) => (
                <li>
                  <a
                    href={`/hi/learn/${l.id}`}
                    class:list={[
                      'block px-3 py-2 rounded text-sm transition-colors min-h-[44px] flex items-center',
                      l.id === lesson.id
                        ? 'bg-vermillion/10 text-vermillion dark:text-vermillion-light font-medium'
                        : 'text-stone-600 dark:text-stone-400 hover:bg-surface-bark/50 dark:hover:bg-charcoal-800',
                    ]}
                    {...(l.id === lesson.id ? { 'aria-current': 'page' } : {})}
                  >
                    {l.data.title_hi}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </nav>
    </details>

    <div class="lg:grid lg:grid-cols-[220px_1fr] lg:gap-8">
      <!-- Sidebar (desktop only) -->
      <aside class="hidden lg:block">
        <nav class="sticky top-20 space-y-4" aria-label="मॉड्यूल नेविगेशन">
          {modules.map((mod) => (
            <div>
              <h3 class="text-xs font-bold uppercase tracking-wider text-stone-400 dark:text-stone-500 mb-2">
                {mod.title_hi}
              </h3>
              <ul class="space-y-1">
                {mod.lessons.map((l) => (
                  <li>
                    <a
                      href={`/hi/learn/${l.id}`}
                      class:list={[
                        'block px-3 py-2 rounded text-sm transition-colors min-h-[44px] flex items-center',
                        l.id === lesson.id
                          ? 'bg-vermillion/10 text-vermillion dark:text-vermillion-light font-medium'
                          : 'text-stone-600 dark:text-stone-400 hover:bg-surface-bark/50 dark:hover:bg-charcoal-800',
                      ]}
                      {...(l.id === lesson.id ? { 'aria-current': 'page' } : {})}
                    >
                      {l.data.title_hi}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </nav>
      </aside>

      <!-- Main content -->
      <article class="min-w-0">
        <header class="mb-8">
          <h1 class="text-2xl md:text-3xl font-bold text-ink dark:text-stone-100 leading-tight">
            {lesson.data.title_hi}
          </h1>
          <p class="mt-2 text-sm text-clay dark:text-stone-400">
            अनुमानित समय: {lesson.data.estimated_minutes} मिनट
          </p>
        </header>

        <div class="prose prose-stone dark:prose-invert prose-headings:font-serif prose-table:text-sm max-w-none
          prose-th:bg-turmeric/20 dark:prose-th:bg-charcoal-800 prose-th:px-3 prose-th:py-2
          prose-td:px-3 prose-td:py-2 prose-table:border-collapse
          prose-th:border prose-th:border-border-subtle dark:prose-th:border-charcoal-700
          prose-td:border prose-td:border-border-subtle dark:prose-td:border-charcoal-700">
          <slot />
        </div>

        {exercises.length > 0 && (
          <section class="mt-12 pt-8 border-t border-border-subtle dark:border-charcoal-700">
            <h2 class="text-xl font-bold text-ink dark:text-stone-100 mb-6">अभ्यास</h2>
            <ExerciseSet exercises={exercises} client:visible />
          </section>
        )}

        <LessonNav prev={prev} next={next} />
      </article>
    </div>
  </div>
</BaseLayout>
